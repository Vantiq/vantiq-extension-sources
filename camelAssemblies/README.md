# Overview

This document outlines the contents of the `CamelAssemblies` subproject within the extension sources repo.

The `CamelAssemblies` subproject creates Vantiq projects from
[Camel Kamelet Definitions](https://camel.apache.org/camel-kamelets/3.21.x/). These projects will
be made available in a Vantiq Public Catalog as _Vantiq assemblies_. These assemblies, when imported,
create Vantiq services and sources for connections to or from external systems supported by Apache Camel.

# Prerequisites <a name="pre" id="pre"></a>

**IMPORTANT:** A basic understanding of the [Vantiq Camel Connector](../camelConnector/README.md) is assumed.

All assemblies contained herein (Vantiq Camel assemblies) are built atop the base Camel Connector assembly, 
`com.vantiq.extsrc.camel4conn.camelConnector`.  Specifically, the Camel Connector 
assembly defines the Camel Connector source implementation type and the schema type
`com.vantiq.extsrc.camelcomp.message` that defines the message format for messages used between the Camel connector
and the Vantiq system.

# Repository Contents

Apache Camel, briefly, is organized into a set of _components_ that are used to integrate with other software 
systems. The Vantiq Camel Connector provides the ability to load the components necessary to operate _routes_, 
Camel's means for describing the interaction between information systems.

Apache Kamelets are packages containing the routes and associated settings needed to set up connections using Apache
Camel-K. 

The assemblies generated by this subproject take the information contained in the Kamelet
definitions, constructing
Vantiq Camel assemblies that contain services and Vantiq sources ready to use in a Vantiq system.
This subproject will generate Vantiq assemblies from the Camel definitions downloaded 
as the `camel-kamelet` library from the dependencies (see the `build.gradle` file in this subproject).
To generate the assembles, just run `../gradlew assemble`. After that, the Vantiq assemblies will be
located in zip files under the build/distributions directory.
For example,`build/distributions/ftp_sink_v4_4_3.zip`.

## Terminology and Naming

Generally, there are two Vantiq Camel assemblies provided for each system for which assemblies are created. Assemblies 
for 
sending data _to_ another system are thought of as _sinks_, and have the word `sink` in the assembly name and the
names of the included Vantiq components. Those that get data _from_ another system have the word `source` in the names.

Each assembly and its included components are named including the name of the system with which they
interact and the Apache Camel version in use (kamelets are Camel version specific).  For example, an assembly using 
Camel version 4.4.3 for consuming information from Amazon's AWS S3 will be in the Vantiq Camel assembly

    com.vantiq.extsrc.camel.kamelets.v4_4_3.aws_s3_source

while an assembly for sending data to Amazon's AWS SNS will be found in

    com.vantiq.extsrc.camel.kamelets.v4_4_3.aws_sns_sink

For each of these cases, the Vantiq components contained in the assembly will have that assembly name as their 
package name. The _base name_ for Vantiq components will be the kamelet name, with suffixes specific to the Vantiq 
component type.

Each Vantiq Camel assembly is realized via a [Vantiq Camel Connector](../camelConnector/README.md). The connector is 
configured to make the connection to the associated information system via the Camel route defined in the assembly.

## Constructed Vantiq Camel Assemblies

The Vantiq Camel assemblies contained herein are composed of the following.

* Vantiq Source -- this is the Vantiq component that represents the external system to the Vantiq environment.
  * The Vantiq source will be of type `CAMEL`. This is defined in the Camel Connector assembly `com.vantiq.extsrc.
    camel4conn.camelConnector`.
  * The source's configuration will include the Camel route to/from (source/sink) the external source via Camel 
    Component(s).
  * The configuration may include configuration information (such as credentials, type of interaction) generated 
    from Vantiq assembly configuration parameters.
  * The Vantiq source is in the package matching the assembly name, with the name consisting
      of the base name with the suffix `_source`.
* Vantiq Service -- this is the Vantiq item with which Vail code interacts.
  * The service interacts with the Vantiq source to move information to/from the Vantiq system.
  * The service is in the package matching the assembly name, and named with the base name with the suffix 
    `_service`.  For example, `com.vantiq.extsrc.camel.kamelets.v4_4_3.aws_sns_sink.aws_sns_sink_service`.
  * Each service is defined with an _inbound_ or _outbound_ event named with the base name with the suffix 
    `_serviceEvent`. Continuing the example above, `aws_sns_sink_serviceEvent` (so the full service event name is 
    `com.vantiq.extsrc.camel.kamelets.v4_4_3.aws_sns_sink.aws_sns_sink_service/aws_sns_sink_serviceEvent`).
* Vantiq Deployment Service
  * A service is created to deploy a Vantiq Camel Connector to a Vantiq K8s CLuster.
  * The service name is in the assembly's package, and named with the base name with the suffix `_Deployment`.
  * The service contains a procedure `deployToK8s()`, with the following parameters:
    * **clusterName** -- the name of the K8sCluster to which to deploy the connector
    * **installationName** -- the name of the installation being deployed
    * **k8sNamespace** -- (optional) the name of the Kubernetes namespace into which to deploy the connector
    * **targetUrl** -- (optional) the URL of the Vantiq server with which the connector will work. This will default 
      to the value given upon installation of the Camel Connector assembly or that determined from the Vantiq 
      installation.  See
      [Camel Connector assembly](../camelConnector/README.md#assemblyInstallation) for further details
    * **accessToken** -- (optional) the access token value to use. As with the **targetUrl**, the value can be taken 
      from the Camel Connector assembly installation.  This should be provided via a Vantiq Secret using `@secrets()`.
    * **cpuLimit** -- (optional) the CPU limit to provide for the _request limits_ parameter. If not provided, will 
      use the value provided as part of the Camel Connector asssembly, or a default value.
    * **memoryLimit** -- (optional) the memory limit to provide for the _request limits_ parameter. If not provided, 
      will use the value provided as part of the Camel Connector asssembly, or a default value.
    * **connectorImageTag** -- (optional, very rarely used) The image tag used to fetch the Camel Connector image 
      from the image repository.  Primarily provided for developers.
* Vantiq Rule -- this is the Vantiq component which marshals events between the Vantiq source and Vantiq service.
  * The rules are in the package matching the assembly name, and named using the associated 
       service name with the suffix `_srcToSvc` (for a _sink_ assembly)
       or `_svcToSrc` (for a _source_ assembly).
* Vantiq Documents -- there are a few documents that may be present in the Vantiq Camel assembly.
  * Overview Document -- `<assembly name>_overview.md`.  This contains the provided high-level description of the 
    assembly. It will often provide other information concerning use of the assembly such as Camel headers required 
    for use, the Vantiq Source created, etc.
  * Route Template Document -- `<assembly name>_routes.yaml`.  This is the routing information used by the Camel 
    Connector. It is referenced by the Vantiq Source configuration.
  * Notes Document (optional) -- `<assembly name>_notes.md`.  When present, this contains information that Vail 
    developers need to know about use of the assembly. Typically, this is information regarding non-standard message 
    structure or functionality. The assemblies are interacting with external systems whose methods of operation are 
    different from that of Vantiq. Amongst other things, the _notes_ document(s) are used to communicate this 
    information when required.

# Vantiq Camel Assemblies in a Vantiq Namespace

## Vantiq Camel Assembly Installation

To make use of any Vantiq Camel assembly defined herein, the user should perform the following tasks.

* Add the Vantiq Catalog containing the definitions. In Vantiq public systems, this is, at the time of this writing, 
  named `CamelCatalog`. This must be done once per namespace into which any of these assemblies will be installed.
* From that catalog, install the `com.vantiq.extsrc.camel4conn.camelConnector` assembly. This is a prerequisite for 
  the Vantiq Camel assemblies.  See the [Camel Connector document](../camelConnector/README.md).
  * As with the addition of the Vantiq Catalog, this needs to be done once per Vantiq namespace in which these 
    assemblies are being used.
  * This assembly defines the following items:
    * The `CAMEL` source implementation type.
    * The Vantiq _schema_ used for the _structured messages_ used to interact with the source.
    * A deployment procedure used to deploy the connector to Kubernetes via a Vantiq K8sCluster.
* From that catalog, install the Vantiq Camel assembly or assemblies desired, providing the configuration properties as 
  requested. 
  * These configuration properties will often include addressing information and credentials for the remote systems. 
    It is strongly suggested that credential information (or other confidential information) be stored in Vantiq 
    Secrets, and referenced using the `@secrets()` notation.

## Using the Vantiq Camel Assemblies

Once installed, each Vantiq Camel assembly creates a source & service for interacting with that source.

The source is defined and implemented via a [Camel Connector](../camelConnector/README.md). To run the Camel 
Connector, please see the [Camel Connector overview](../camelConnector/README.md). To deploy said connector using a 
Vantiq K8sCluster, see [Deploying the Camel Connector to Kubernetes](#deploying-the-camel-connector-to-kubernetes)

As noted above, the service will have an inbound or outbound event defined, and interactions with the service are
generally performed by publishing to that event or handling it (for _inbound_ or _outbound_ events).
All are constructed to use _structured messages_ as defined by the 
[Camel Component](../camelComponent/README.md#structured-headers-and-messages). Consequently, messages sent to/from 
the service should be in this format. Specifically, such messages contain two (2) properties: `header` and `message`,
where the `header` property contains the Camel headers, and the `message` property contains Camel message.
The associated Vantiq _schema_ is defined via the `com.vantiq.extsrc.camel4conn.camelConnector` assembly imported as 
described above.  This imported assembly is a prerequisite for the other Vantiq Camel assemblies.

**Note**: With some of these Vantiq Camel assemblies (specifically those that work with systems
with limited messaging capabilities),
the Vantiq Component will construct output messages (the `message` property) with a single 
property (`stringVal` or `byteVal`) containing the 
message content. This allows Vantiq applications to interact in a Vantiq application native manner.
Users of these systems will need to be aware of this _impendance mismatch_ and respond accordingly.

## Logging & Debugging

These Vantiq Camel assemblies themselves provide no direct support for logging or debugging -- they are simply 
specifications for 
Apache Camel applications. To debug what is happening, you will need to look at the component definitions used in 
the assembly.  Generally, these will include the component for the target system and the [Vantiq component](../camelComponent/README.md).
Information about other components is (usually) found in the 
[Apache Component catalog](https://camel.apache.org/components/3.21.x/index.html).

# Deploying the Camel Connector to Kubernetes

Assuming you have K8sCluster defined in your Vantiq namespace, you are free to deploy the installation using the 
usual Vantiq tools.  The name of the source defined by the assembly is provided in the overview document (and 
the assembly description in the catalog).

However, to make this simpler, each assembly includes connector deployment service that can be 
used to perform this function. 

Each assembly contains such a service for performing the deployment. The service is in the same package as other things 
within the assembly, and is named using the base name with the `_Deployment` suffix.  So, for example, the 
deployment service for the AWS EventBridge sink is

`com.vantiq.extsrc.camel.kamelets.v4_4_3.aws_eventbridge_sink.Aws_eventbridge_sink_Deployment`

with the deployment procedure being

`com.vantiq.extsrc.camel.kamelets.v4_4_3.aws_eventbridge_sink.Aws_eventbridge_sink_Deployment.deployToK8s()`

The actions required to perform the deployment are the same as those described for 
[deploying a Camel Connector](../camelConnector/README.md#camelConnectorDeployment) with two (2) differences:

1) The service and procedure to use varies from assembly to assembly
  (they are named and packaged as per the assembly), and
2) The source name value should not (cannot) be provided.  It is provided by the assembly and the specialized 
   service contained therein.

So, using the same assembly as an example, assembly installation will provide the service definition

![EventBridge Deployment Service](docs/images/EventBrdgDepSvc.png)

From there, you can execute the `deployToK8s` procedure by pressing the _Execute_ button.

![EventBridge Deployment Procedure](docs/images/EventBrdgDepProc.png)

which will present you with a set of parameter values to provide.

![EventBridge Deployment](docs/images/EventBrdgDeployment.png)

As with the underlying Camel Connector (on which these assemblies are based), the `clusterName` and 
`installationName` values are required, but the remainder are optional.  They will take their defaults from the 
Camel Connector assembly installation or from the system.

Note:  The K8sInstallation created by this deployment procedure will pull the Camel Connector source image
from a repository at quay.io.  The image is made available in a public
repository, so no credentials are required.

# Development using this Git Repo

The assemblies contained herein are produced from the Kamelet definitions downloaded as dependencies. Should you 
wish to populate your own catalogs, run the build step outlined [above](#repository-contents).

Once that is done, you can import the assembly projects to a Vantiq namespace, and, from there, publish these 
assemblies to a catalog.  The steps involved are as follows.

## Importing Assemblies

This can be done manually (using the Vantiq IDE to import the generated projects).

However, if importing many projects, use `../gradlew importAssemblies -PcamelAssembliesProfile=<profileName>`

where `<profileName>` is the name of a Vantiq CLI profile that will connect to your publishing namespace.  Other 
gradle properties that are used are based on that profile name, and are as follows.

* **\<profileName\>_camelAssembliesVantiq** -- command to be used as the Vantiq CLI.  Defaults to `vantiq`. 
* **\<profileName\>_camelAssembliesList** -- a comma-separated list of the simple names of the assemblies you wish to 
  import.  Defaults to all assemblies.

## Publishing Assemblies

Once imported, the assemblies can be published. This can be done manually (using the Vantiq IDE to publish the 
generated and imported projects to a Catalog).

However, if importing many projects, use `../gradlew publishAssemblies -PcamelAssembliesProfile=<profileName>`.

In addition to the gradle properties used for import, you can define the following.

* **\<profileName\>_camelAssembliesCatalog** -- the name of the catalog to which to publish the assemblies.  This is 
  required, and may be specified on the command line or in the `gradle.properties` file.
* **changeLog** -- change log entry to include.  A very short (no spaces) description of what this upload entails.

## Use of the Gradle Properties

Generally, the likely behavior is that you would define all of the **<profileName>_camelAssemblies...** properties 
in the `gradle.properties` file.  This is not required, but it generally makes your gradle command line easier to 
manage.  Then, on the command line, select the profile name to use (`-PcamelAssembliesProfile=...`) and your change 
log entry (if appropriate and desired).  The profile name is used to select the other properties so you can keep a 
number of them if you have multiple catalogs to maintain.


# Licensing

The source code uses the [MIT License](https://opensource.org/licenses/MIT).  

okhttp3, log4j, gson, and jackson-databind are licensed under
[Apache Version 2.0 License](http://www.apache.org/licenses/LICENSE-2.0).  

slf4j and lombok are licensed under the [MIT License](https://opensource.org/licenses/MIT).  

Apache, Camel, and Apache Camel are trademarks of the Apache Software Foundation and are licensed under
[Apache Version 2.0 License](http://www.apache.org/licenses/LICENSE-2.0). 
